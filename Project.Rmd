---
title: "Project"
output: html_document
date: "2024-12-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
if(!require(pacman))
  install.packages("pacman")

pacman::p_load(tidyverse, ggplot2, dplyr, cluster, arules, arulesViz, lubridate)
```

```{r}
retail <- read.csv("/Users/praagnya/Desktop/Project DM/data/OnlineRetail.csv", stringsAsFactors = FALSE)
```

```{r}
head(retail)
```

Data Cleaning

```{r}
# Calculate missing values percentage
retail_null <- round(100 * colSums(is.na(retail)) / nrow(retail), 2)

# Display result
retail_null
```

```{r}
# Remove rows with any missing values
retail_clean <- na.omit(retail)

# Check the structure of the cleaned dataset
str(retail_clean)
```

Data Preparation

```{r}
# Convert InvoiceDate to a datetime object
retail_clean$InvoiceDate <- dmy_hm(retail_clean$InvoiceDate)

# Check the structure of the InvoiceDate column
str(retail_clean$InvoiceDate)

# Preview the first few rows
head(retail_clean$InvoiceDate)
```

```{r}
# Create Amount column
retail_clean <- retail_clean %>%
  mutate(Amount = Quantity * UnitPrice)

# Calculate Monetary
rfm_m <- retail_clean %>%
  group_by(CustomerID) %>%
  summarise(Amount = sum(Amount, na.rm = TRUE))

# Calculate Frequency
rfm_f <- retail_clean %>%
  group_by(CustomerID) %>%
  summarise(Frequency = n_distinct(InvoiceNo))

# Calculate Recency
rfm_r <- retail_clean %>%
  group_by(CustomerID) %>%
  summarise(LastPurchase = max(InvoiceDate, na.rm = TRUE)) %>%
  mutate(Recency = as.numeric(difftime(Sys.Date(), as.Date(LastPurchase), units = "days")))

# Combine RFM metrics
rfm <- rfm_m %>%
  inner_join(rfm_f, by = "CustomerID") %>%
  inner_join(rfm_r, by = "CustomerID") %>%
  select(CustomerID, Recency, Frequency, Amount)

# Merge RFM metrics back to the original dataset
retail_clean <- retail_clean %>%
  left_join(rfm, by = "CustomerID")

# Preview the final dataset
head(retail_clean)
```

```{r}
# Rename Amount.x to Amount and Amount.y to Monetary
retail_clean <- retail_clean %>%
  rename(
    Amount = Amount.x,
    Monetary = Amount.y
  )

# Check the structure to confirm the changes
str(retail_clean)
```
```{r}
# Compute the maximum date from the dataset
max_date <- max(retail_clean$InvoiceDate, na.rm = TRUE)

# Compute the difference between the max date and each transaction date
retail_clean <- retail_clean %>%
  mutate(Diff = as.numeric(difftime(max_date, InvoiceDate, units = "days")))

# Preview the updated dataset
head(retail_clean)
```

```{r}
# Convert InvoiceDate to a datetime object
retail_clean$InvoiceDate <- as.POSIXct(retail_clean$InvoiceDate)

# Calculate the difference in days
retail_clean <- retail_clean %>%
  mutate(Diff = as.integer(difftime(max_date, InvoiceDate, units = "days")))
```

Exploratory Data Analysis

1. Transaction Volume Over Time

```{r}
transactions_by_date <- retail_clean %>%
  mutate(InvoiceDate = as.Date(InvoiceDate)) %>%
  group_by(InvoiceDate) %>%
  summarise(TransactionVolume = n())

# Plot transaction volume over time
ggplot(transactions_by_date, aes(x = InvoiceDate, y = TransactionVolume)) +
  geom_line() +
  labs(
    title = "Transaction Volume Over Time",
    x = "Date",
    y = "Number of Transactions"
  ) +
  theme_minimal()
```
2. Revenue Over Time

```{r}
# Aggregate revenue by date
revenue_by_date <- retail_clean %>%
  mutate(InvoiceDate = as.Date(InvoiceDate)) %>%
  group_by(InvoiceDate) %>%
  summarise(DailyRevenue = sum(Amount, na.rm = TRUE))

# Plot revenue over time
ggplot(revenue_by_date, aes(x = InvoiceDate, y = DailyRevenue)) +
  geom_line(color = "blue") +
  labs(
    title = "Daily Revenue Over Time",
    x = "Date",
    y = "Revenue"
  ) +
  theme_minimal()
```
3. Hourly Transaction Patterns

```{r}
# Extract hour from InvoiceDate
hourly_transactions <- retail_clean %>%
  mutate(Hour = lubridate::hour(InvoiceDate)) %>%
  group_by(Hour) %>%
  summarise(TransactionCount = n())

# Plot hourly transaction patterns
ggplot(hourly_transactions, aes(x = Hour, y = TransactionCount)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Hourly Transaction Patterns",
    x = "Hour of the Day",
    y = "Number of Transactions"
  ) +
  theme_minimal()
```
4. Day of the Week Analysis

```{r}
# Extract day of the week
weekday_transactions <- retail_clean %>%
  mutate(Weekday = lubridate::wday(InvoiceDate, label = TRUE)) %>%
  group_by(Weekday) %>%
  summarise(TransactionCount = n())

# Plot transactions by weekday
ggplot(weekday_transactions, aes(x = Weekday, y = TransactionCount)) +
  geom_bar(stat = "identity", fill = "coral") +
  labs(
    title = "Transactions by Day of the Week",
    x = "Day of the Week",
    y = "Number of Transactions"
  ) +
  theme_minimal()
```
5. Monthly Revenue by Month 

```{r}
# Aggregate revenue by month
monthly_revenue <- retail_clean %>%
  mutate(Month = lubridate::floor_date(InvoiceDate, unit = "month")) %>%
  group_by(Month) %>%
  summarise(MonthlyRevenue = sum(Amount, na.rm = TRUE))

# Plot monthly revenue trends
ggplot(monthly_revenue, aes(x = Month, y = MonthlyRevenue)) +
  geom_line(color = "green") +
  labs(
    title = "Monthly Revenue Trends",
    x = "Month",
    y = "Revenue"
  ) +
  theme_minimal()
```
6. Heatmap of Hourly and Weekly Patterns

```{r}
# Create a heatmap of transactions by hour and weekday
heatmap_data <- retail_clean %>%
  mutate(
    Hour = lubridate::hour(InvoiceDate),
    Weekday = lubridate::wday(InvoiceDate, label = TRUE)
  ) %>%
  group_by(Weekday, Hour) %>%
  summarise(TransactionCount = n())

# Plot heatmap
ggplot(heatmap_data, aes(x = Hour, y = Weekday, fill = TransactionCount)) +
  geom_tile() +
  labs(
    title = "Heatmap of Transactions by Hour and Day of the Week",
    x = "Hour of the Day",
    y = "Day of the Week",
    fill = "Transactions"
  ) +
  theme_minimal()
```


